<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Diária - Peck Advogados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuração de cores personalizadas para Tailwind */
        :root {
            --peck-light-teal: 104, 173, 163;
            --peck-dark-teal: 0, 75, 87;
            --peck-accent-green: 198, 255, 0;
        }

        .bg-peck-light-teal { background-color: rgb(var(--peck-light-teal)); }
        .text-peck-light-teal { color: rgb(var(--peck-light-teal)); }
        .border-peck-light-teal { border-color: rgb(var(--peck-light-teal)); }

        .bg-peck-dark-teal { background-color: rgb(var(--peck-dark-teal)); }
        .text-peck-dark-teal { color: rgb(var(--peck-dark-teal)); }
        .border-peck-dark-teal { border-color: rgb(var(--peck-dark-teal)); }

        .bg-peck-accent-green { background-color: rgb(var(--peck-accent-green)); }
        .text-peck-accent-green { color: rgb(var(--peck-accent-green)); }
        .border-peck-accent-green { border-color: rgb(var(--peck-accent-green)); }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Um cinza claro para o fundo */
        }
        /* Estilo para a imagem de placeholder */
        .placeholder-image {
            width: 100%;
            height: 180px; /* Altura fixa para as imagens */
            object-fit: cover; /* Garante que a imagem cubra o espaço sem distorcer */
            border-radius: 0.5rem; /* Arredonda as bordas */
        }

        /* Estilo para o campo de data */
        input[type="date"] {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid rgb(var(--peck-light-teal));
            background-color: white;
            color: rgb(var(--peck-dark-teal));
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease-in-out;
        }

        input[type="date"]:focus {
            border-color: rgb(var(--peck-accent-green));
            box-shadow: 0 0 0 3px rgba(var(--peck-accent-green), 0.3);
        }

        /* Estilo para o modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">
        <header class="w-full max-w-4xl bg-peck-dark-teal text-white p-6 rounded-xl shadow-lg mb-8 flex flex-col sm:flex-row items-center justify-between">
            <div class="flex items-center mb-4 sm:mb-0">
                <div class="w-12 h-12 bg-peck-accent-green rounded-full flex items-center justify-center mr-4">
                    <span class="font-bold text-peck-dark-teal text-xl">P</span>
                </div>
                <h1 class="text-3xl font-extrabold tracking-tight">Newsletter Diária</h1>
            </div>
            <div class="flex flex-col items-end">
                <p class="text-lg font-medium">Peck Advogados</p>
                <div class="mt-4">
                    <label for="news-date" class="block text-sm font-medium text-white mb-2">Selecione a Data:</label>
                    <input type="date" id="news-date" class="form-input" />
                </div>
            </div>
        </header>

        <main id="news-container" class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </main>

        <div id="no-news-message" class="hidden w-full max-w-4xl text-center text-peck-dark-teal text-xl font-semibold mt-8 p-6 bg-white rounded-xl shadow-lg">
            Nenhuma notícia encontrada para a data selecionada.
        </div>
    </div>

    <div id="legalAnalysisModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 class="text-2xl font-bold text-peck-dark-teal mb-4" id="modalTitle">Análise Jurídica</h2>
            <div id="modalContent" class="text-gray-700">
                </div>
            <div id="modalLoading" class="text-center py-4 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-peck-dark-teal mx-auto"></div>
                <p class="text-peck-dark-teal mt-2">Gerando análise...</p>
            </div>
        </div>
    </div>

    <script>
        // Função para formatar a data para exibição
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('pt-BR', options);
        }

        const newsContainer = document.getElementById('news-container');
        const newsDateInput = document.getElementById('news-date');
        const noNewsMessage = document.getElementById('no-news-message');
        const legalAnalysisModal = document.getElementById('legalAnalysisModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const modalLoading = document.getElementById('modalLoading');

        // Função para exibir o modal
        function openModal() {
            legalAnalysisModal.style.display = 'flex';
        }

        // Função para fechar o modal
        function closeModal() {
            legalAnalysisModal.style.display = 'none';
            modalContent.innerHTML = ''; // Limpa o conteúdo ao fechar
            modalLoading.classList.add('hidden'); // Esconde o loading
        }

        // Função para gerar a análise jurídica usando a API Gemini
        async function generateLegalAnalysis(title, summary) {
            openModal();
            modalTitle.textContent = 'Análise Jurídica para: ' + title;
            modalContent.innerHTML = '';
            modalLoading.classList.remove('hidden'); // Mostra o loading

            const prompt = `Como um especialista em direito digital, forneça uma breve análise das implicações legais da seguinte notícia, focando em aspectos relevantes para um escritório de advocacia:

            Título: "${title}"
            Resumo: "${summary}"

            A análise deve ser concisa e objetiva.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Deixe como está, a chave será fornecida em tempo de execução
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    modalContent.innerHTML = `<p>${text}</p>`;
                } else {
                    modalContent.innerHTML = '<p class="text-red-500">Não foi possível gerar a análise. Tente novamente.</p>';
                }
            } catch (error) {
                console.error('Erro ao chamar a API Gemini:', error);
                modalContent.innerHTML = '<p class="text-red-500">Ocorreu um erro ao conectar com o serviço de análise. Por favor, tente novamente mais tarde.</p>';
            } finally {
                modalLoading.classList.add('hidden'); // Esconde o loading
            }
        }

        // Função para renderizar as notícias
        async function renderNews(date) {
            newsContainer.innerHTML = ''; // Limpa o container de notícias
            noNewsMessage.classList.add('hidden'); // Esconde a mensagem de "nenhuma notícia"

            try {
                const response = await fetch(`/api/news?date=${date}`); // Chama sua nova API
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const filteredNews = await response.json();

                if (filteredNews.length === 0) {
                    noNewsMessage.classList.remove('hidden'); // Mostra a mensagem se não houver notícias
                    return;
                }

                // Limita a 20 notícias, se houver mais (já feito na API, mas bom ter aqui tbm)
                const newsToDisplay = filteredNews.slice(0, 20);

                newsToDisplay.forEach(news => {
                    const newsCard = document.createElement('div');
                    newsCard.className = 'bg-white rounded-xl shadow-md overflow-hidden transform transition duration-300 hover:scale-105 hover:shadow-lg';
                    newsCard.innerHTML = `
                        <img src="${news.image}" alt="${news.title}" class="placeholder-image">
                        <div class="p-6">
                            <span class="inline-block bg-peck-light-teal text-peck-dark-teal text-xs font-semibold px-3 py-1 rounded-full mb-3">
                                ${news.category}
                            </span>
                            <h3 class="text-xl font-semibold text-peck-dark-teal mb-2">${news.title}</h3>
                            <p class="text-gray-600 text-sm mb-4">${news.summary}</p>
                            <span class="text-xs text-gray-400">Publicado em: ${formatDate(news.date)}</span>
                            <button onclick="generateLegalAnalysis('${news.title.replace(/'/g, "\\'")}', '${news.summary.replace(/'/g, "\\'")}')"
                                    class="mt-4 w-full bg-peck-accent-green text-peck-dark-teal font-bold py-2 px-4 rounded-full hover:bg-opacity-90 transition duration-300 ease-in-out flex items-center justify-center">
                                Análise Jurídica ✨
                            </button>
                        </div>
                    `;
                    newsContainer.appendChild(newsCard);
                });
            } catch (error) {
                console.error('Erro ao buscar notícias:', error);
                newsContainer.innerHTML = `<p class="text-red-500">Ocorreu um erro ao carregar as notícias. Por favor, tente novamente.</p>`;
                noNewsMessage.classList.add('hidden'); // Esconde a mensagem de "nenhuma notícia" em caso de erro.
            }
        }

        // Define a data atual como padrão no campo de data
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0'); // Mês é 0-indexado
        const day = String(today.getDate()).padStart(2, '0');
        const defaultDate = `${year}-${month}-${day}`;
        newsDateInput.value = defaultDate;

        // Renderiza as notícias para a data padrão ao carregar a página
        renderNews(defaultDate);

        // Adiciona um listener para o evento 'change' no seletor de data
        newsDateInput.addEventListener('change', (event) => {
            const selectedDate = event.target.value;
            renderNews(selectedDate);
        });
    </script>
</body>
</html>